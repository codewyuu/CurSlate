(self.webpackChunk=self.webpackChunk||[]).push([[4621],{46165:(o,e,n)=>{var t=n(46165),r=n(11568),s=n(91565),c=n(7125),i=n(74928),a=n(47059);o.exports=function(o,e){o=o||{};var n,l=c(),d=a.json(),u=o.urlRoot||"/api/vm/net";n=o.server?o.server:r.createServer();var f={};if(o.allowOrigin){var h=o.allowOrigin;"string"!=typeof o.allowOrigin&&(h=!0===o.allowOrigin?"*":""),h&&l.use((function(o,e,n){0===o.path.indexOf(u)?(e.header("Access-Control-Allow-Origin",h),"OPTIONS"==o.method.toUpperCase()&&(e.header("Access-Control-Allow-Methods","GET, POST, OPTIONS"),e.header("Access-Control-Allow-Headers","Content-Type"),e.header("Access-Control-Max-Age",1728e3)),n()):n()}))}return l.post(u+"/connect",d,(function(n,r){var c=n.body.host,i=n.body.port;if(c&&i)if(!o.to||function(o,e){o instanceof Array||(o=[o]);for(var n=0;n<o.length;n++){var t=o[n];if(!(t.host!=e.host&&t.host||t.port!=e.port&&t.port))return!t.blacklist}return!1}(o.to,{host:c,port:i})){var a=t.connect({host:c,port:i},(function(o){if(o)r.status(500).send({code:500,error:o});else{var e=s.randomBytes(32).toString("hex");f[e]=a,a.on("end",(function(){f[e]&&delete f[e]})),console.log("Connected to "+n.body.host+":"+n.body.port+" ("+e+")");var t=a.address();r.send({token:e,remote:t})}}));a.on("error",(function(o){r.finished?console.log("Socket error after response closed: "+o):r.status(502).send({code:502,error:"Socket error: "+o.code,details:o})})),e&&e(a)}else r.status(403).send({code:403,error:"Destination not allowed"});else r.status(400).send({code:400,error:"No host and port specified"})})),i(l,n),l.ws(u+"/socket",(function(o,e){var n=e.query.token;if(!f[n])return console.warn('WARN: Unknown TCP connection with token "'+n+'"'),void o.close();var t=f[n];console.log("Forwarding socket with token "+n),o.on("message",(function(o,e){t.write(e.buffer||o,"binary",(function(){}))})),t.on("data",(function(e){o.send(e,{binary:!0},(function(o){}))})),t.on("end",(function(){console.log("TCP connection closed by remote ("+n+")"),o.close()})),o.on("close",(function(){t.end(),console.log("Websocket connection closed ("+n+")")}))})),l.on("mount",(function(o){o.listen=function(){return n.addListener("request",this),n.listen.apply(n,arguments)}})),l}}}]);